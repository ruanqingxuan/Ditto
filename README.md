# Dittoï¼šåŸºäºç”¨æˆ·éœ€æ±‚æ„ŸçŸ¥çš„æ‹¥å¡æ§åˆ¶æœºåˆ¶

## ğŸ“Œ é¡¹ç›®ç®€ä»‹

**Ditto** æ˜¯ä¸€ç§**åŸºäºç”¨æˆ·éœ€æ±‚æ„ŸçŸ¥çš„ç½‘ç»œæ‹¥å¡æ§åˆ¶æœºåˆ¶**ï¼Œæ—¨åœ¨çªç ´ä¼ ç»Ÿæ‹¥å¡æ§åˆ¶ç®—æ³•ä»…ä¾æ®ç½‘ç»œçŠ¶æ€ï¼ˆå¦‚å¸¦å®½ã€RTTã€ä¸¢åŒ…ç‡ï¼‰è¿›è¡Œè°ƒèŠ‚çš„å±€é™ï¼Œé€šè¿‡æ˜¾å¼å»ºæ¨¡ç”¨æˆ·å¯¹ä¸åŒä¼ è¾“æ€§èƒ½æŒ‡æ ‡çš„åå¥½ï¼Œå®ç°æ›´åŠ çµæ´»ã€ä¸ªæ€§åŒ–çš„ä¼ è¾“æ§åˆ¶ã€‚

Ditto çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> åœ¨ä¼ è¾“å±‚æ„ŸçŸ¥ç½‘ç»œçŠ¶æ€çš„åŒæ—¶ï¼Œå¼•å…¥ç”¨æˆ·éœ€æ±‚ä¿¡æ¯ï¼ŒåŠ¨æ€è°ƒæ•´æ‹¥å¡æ§åˆ¶ç­–ç•¥ï¼Œåœ¨ååé‡ã€æ—¶å»¶ç­‰æŒ‡æ ‡ä¹‹é—´å®ç°æŒ‰éœ€æƒè¡¡ã€‚

æœ¬é¡¹ç›®åŸºäº **QUIC åè®®æ ˆ xQUIC**ï¼Œå¹¶åœ¨ **Tengine + ngx_http_xquic_module** ä¸Šå®Œæˆå·¥ç¨‹å®ç°ï¼Œæ”¯æŒåœ¨çœŸå®ç½‘ç»œç¯å¢ƒä¸‹è¿›è¡Œ HTTP/3 æœåŠ¡éƒ¨ç½²ä¸å®éªŒè¯„ä¼°ã€‚

------

## ğŸ§© ä»£ç ç»„æˆ

æœ¬é¡¹ç›®å›´ç»• **Ditto æ‹¥å¡æ§åˆ¶æœºåˆ¶** çš„å®ç°ä¸éªŒè¯ï¼Œæ•´ä½“ä»£ç ä¸»è¦ç”± **Tengineã€XQUIC ä»¥åŠæµ‹è¯•å®¢æˆ·ç«¯** ç»„æˆï¼Œå¹¶ä¾èµ–è‹¥å¹²åŸºç¡€åº“å®ŒæˆåŠ å¯†ã€é…ç½®ä¸å®éªŒæ”¯æ’‘ã€‚

#### ğŸ“ ä»£ç ä¸»è¦ç›®å½•ç»“æ„

```
Ditto/
â”œâ”€â”€ tengine/          # Web æœåŠ¡å™¨ï¼ˆHTTP/3 æœåŠ¡ç«¯ï¼‰
â”œâ”€â”€ xquic/            # QUIC åè®®æ ˆï¼ˆDitto æ ¸å¿ƒå®ç°ï¼‰
â”œâ”€â”€ testclient/       # å®éªŒç”¨å®¢æˆ·ç«¯ç¨‹åº
â”œâ”€â”€ start-1.6.0.sh/   # ç¼–è¯‘ä¸æµ‹è¯•è„šæœ¬
â””â”€â”€ README.md
```

#### å…³é”®ç»„ä»¶è¯´æ˜

- **xQUIC**
  Alibaba å¼€æºçš„ QUIC åè®®å®ç°ï¼Œä½œä¸º Ditto çš„ä¼ è¾“å±‚åŸºç¡€ã€‚
- **Tengine + ngx_http_xquic_module**
  ç”¨äºåœ¨æœåŠ¡ç«¯å¯ç”¨ HTTP/3 æœåŠ¡ï¼Œå¹¶å°† Ditto æ‹¥å¡æ§åˆ¶æœºåˆ¶é›†æˆè‡³å®é™…éƒ¨ç½²ç¯å¢ƒã€‚
- **Ditto æ‹¥å¡æ§åˆ¶é€»è¾‘**
  é›†æˆäº Tengine çš„ QUIC ç›¸å…³æ¨¡å—ä¸­ï¼Œé€šè¿‡ä¿®æ”¹å¹¶é‡æ–°ç¼–è¯‘ Tengine ç”Ÿæ•ˆã€‚

#### ğŸš€ XQUICï¼ˆæ ¸å¿ƒä¿®æ”¹æ¨¡å—ï¼‰

**XQUIC** æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ã€éµå¾ª IETF æ ‡å‡†çš„ QUIC / HTTP3 åè®®å®ç°ï¼Œæ”¯æŒ QUIC v1 å’Œ draft-29ï¼Œæ˜¯ Ditto æ‹¥å¡æ§åˆ¶æœºåˆ¶çš„**æ ¸å¿ƒå®ç°è½½ä½“**ã€‚

ä»“åº“åœ°å€ï¼šhttps://github.com/alibaba/xquic

##### XQUIC ç›®å½•è¯´æ˜

- **build/**
  ç¼–è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ„å»ºç›®å½•ã€‚

- **demo/**
  æä¾›æµ‹è¯•ç”¨çš„æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ç¤ºä¾‹ï¼Œä»¥åŠéƒ¨åˆ† HTTP/3 è¿æ¥ç›¸å…³æºç ï¼Œæœ¬é¡¹ç›®æœªå¯¹è¯¥éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ã€‚

- **docs/**
  åŒ…å«ç¼–è¯‘ä¸æµ‹è¯•è¯´æ˜æ–‡æ¡£ï¼Œå…¶ä¸­ `API.md` è®°å½•äº† XQUIC çš„ä¸»è¦æ¥å£ï¼Œä¾¿äºå¿«é€Ÿç†è§£ä¸äºŒæ¬¡å¼€å‘ã€‚

- **include/**
  XQUIC å¯¹å¤–æš´éœ²çš„åŸºç¡€æ¥å£ä¸ç»“æ„ä½“å®šä¹‰ã€‚

- **interop/**
  QUIC äº’æ“ä½œæµ‹è¯•ç›¸å…³å†…å®¹ï¼Œä¸æœ¬é¡¹ç›®æ— ç›´æ¥å…³è”ã€‚

- **scripts/**
  XQUIC è‡ªå¸¦çš„æµ‹è¯•è„šæœ¬ï¼Œç”¨äºåŸºç¡€åŠŸèƒ½éªŒè¯ã€‚

- **src/** ï¼ˆ**ä¸»è¦ä¿®æ”¹ä½ç½®**ï¼‰
  XQUIC çš„æ ¸å¿ƒæºç ç›®å½•ï¼ŒDitto çš„ä¸»è¦å®ç°é›†ä¸­äºæ­¤ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

  - `transport/conn.c`
  - `transport/send_ctl.c`

  Ditto åœ¨è¯¥éƒ¨åˆ†å®ç°äº†æ–°çš„å‘é€æ§åˆ¶é€»è¾‘ï¼Œå…¶ä¸­ï¼š

  - `active_retrans` ä¸ `CCA_info` ä¸º Ditto æ‹¥å¡æ§åˆ¶çš„æ ¸å¿ƒå®ç°
  - `extra_sample` æä¾›äº† Ditto ä¸­**æ‹¥å¡æ§åˆ¶åˆ‡æ¢æœºåˆ¶**çš„ç¤ºä¾‹å®ç°

- **tests/**
  ç®€å•åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œè¯¥éƒ¨åˆ†æµé‡è§„æ¨¡æœ‰é™ï¼Œ**ä¸é€‚ç”¨äºå¸¦å®½å æ»¡å‹å®éªŒåœºæ™¯**ã€‚

- **third_party/**
  XQUIC ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŒ…æ‹¬ Tongsuo å’Œ libxml2 ç­‰ã€‚

------

#### ğŸŒ Tengineï¼ˆHTTP/3 æœåŠ¡ç«¯ï¼‰

**Tengine** æ˜¯æœ¬é¡¹ç›®ç”¨äºéƒ¨ç½² HTTP/3 æœåŠ¡çš„ Web æœåŠ¡å™¨æ¡†æ¶ï¼Œé€šè¿‡é›†æˆ `ngx_http_xquic_module`ï¼Œå®ç°å¯¹ QUIC / HTTP3 çš„æ”¯æŒã€‚

åœ¨ Ditto ä¸­ï¼š

- ä»…å¯¹ **Tengine æºç ä¸­çš„ QUIC ç›¸å…³æ¨¡å—**è¿›è¡Œäº†ä¿®æ”¹
- Ditto çš„æ‹¥å¡æ§åˆ¶é€»è¾‘é€šè¿‡ xQUIC ç”Ÿæ•ˆ
- ä¿®æ”¹å®Œæˆåéœ€ **é‡æ–°ç¼–è¯‘ Tengine å¹¶ç”Ÿæˆ `tengine-install` ç›®å½•** ç”¨äºéƒ¨ç½²

ä¸»è¦ä¿®æ”¹ä½ç½®ï¼š

```
tengine/
â””â”€â”€ modules/
    â””â”€â”€ ngx_http_xquic_module/
        â””â”€â”€ ngx_xquic.c
```

------

#### ğŸ§ª testclientï¼ˆå®éªŒå®¢æˆ·ç«¯ï¼‰

`testclient` ç”¨äºé…åˆæœåŠ¡ç«¯è¿›è¡Œå®éªŒéªŒè¯ï¼Œæ”¯æŒï¼š

- å»ºç«‹ QUIC / HTTP3 è¿æ¥
- è§¦å‘ä¸åŒç½‘ç»œä¸æ‹¥å¡æ§åˆ¶åœºæ™¯
- æ”¶é›†å®éªŒæ‰€éœ€çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®

è¯¥æ¨¡å—ä¸»è¦ç”¨äºè®ºæ–‡å®éªŒä¸æœºåˆ¶éªŒè¯ï¼Œä¸ä½œä¸ºé€šç”¨å®¢æˆ·ç«¯å‘å¸ƒã€‚

------

#### ğŸ“Œ è¯´æ˜

- æœ¬é¡¹ç›® **ä¸ç›´æ¥ä¿®æ”¹ç³»ç»Ÿç¯å¢ƒ**ï¼Œæ‰€æœ‰åŠŸèƒ½é€šè¿‡é‡æ–°ç¼–è¯‘ Tengine ä¸ xQUIC ç”Ÿæ•ˆ
- Ditto çš„å®ç°é‡ç‚¹ä½äº **XQUIC çš„å‘é€ä¸æ‹¥å¡æ§åˆ¶è·¯å¾„**
- ä»£ç ç»“æ„ä»¥ç§‘ç ”å®éªŒå¤ç°ä¸ºç›®æ ‡è¿›è¡Œç»„ç»‡

------

## ğŸš€ ä»£ç è¿è¡Œä¸éƒ¨ç½²

> âš ï¸ æœ¬é¡¹ç›®ä»…å¯¹ **Tengine æºç ** è¿›è¡Œäº†ä¿®æ”¹ï¼Œéƒ¨ç½²æ–¹å¼ä¸ºï¼š
> **ä¿®æ”¹æºç  â†’ é‡æ–°ç¼–è¯‘ Tengine â†’ ä½¿ç”¨ç”Ÿæˆçš„ tengine-install è¿è¡Œ**

### 1ï¸âƒ£ ç¼–è¯‘ç¯å¢ƒä¾èµ–

- **Tongsuoï¼ˆBabasslï¼‰**
  ç”¨äº QUIC æ‰€éœ€çš„åŠ å¯†æ”¯æŒ
  https://github.com/Tongsuo-Project/Tongsuo
- **xQUIC**
  QUIC åè®®å®ç°
  https://github.com/alibaba/xquic
- **Tengineï¼ˆâ‰¥ 3.0.0ï¼‰**
  Web æœåŠ¡å™¨æ¡†æ¶
  https://github.com/alibaba/tengine

------

### 2ï¸âƒ£ ç¼–è¯‘æµç¨‹æ¦‚è¿°

#### ï¼ˆ1ï¼‰ç¼–è¯‘ Tongsuo

```bash
./config --prefix=/home/qnwang/worknew/babassl
make
make install
```

#### ï¼ˆ2ï¼‰ç¼–è¯‘ XQUIC

```bash
cmake \
  -DXQC_SUPPORT_SENDMMSG_BUILD=1 \
  -DXQC_ENABLE_BBR2=1 \
  -DXQC_ENABLE_RENO=1 \
  -DSSL_TYPE=babassl \
  -DSSL_PATH=... \
  -DSSL_INC_PATH=... \
  -DSSL_LIB_PATH=... \
  -DCMAKE_BUILD_TYPE=Debug \
  -DXQC_ENABLE_EVENT_LOG=1
make -j
```

> è‹¥ä½¿ç”¨ xQUIC â‰¥ 1.6.2ï¼Œéœ€é¢å¤–æ·»åŠ ï¼š
> `-DXQC_NO_PID_PACKET_PROCESS=1`

------

#### ï¼ˆ3ï¼‰ç¼–è¯‘ Tengineï¼ˆé›†æˆ Dittoï¼‰

```bash
./configure \
  --with-xquic-inc="../xquic/include" \
  --with-xquic-lib="../xquic/build" \
  --with-http_v2_module \
  --add-module=modules/ngx_http_xquic_module \
  --with-openssl="../Tongsuo"
make
make install
```

------

### 3ï¸âƒ£ éƒ¨ç½²ä¸è¿è¡Œ

- å°†ä»¥ä¸‹ç›®å½•æ•´ä½“ç§»åŠ¨åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆè·¯å¾„éœ€ä¿æŒä¸€è‡´ï¼‰ï¼š
  - `tengine-install`
  - `xquic`
  - `babassl`

```bash
rsync -av tengine-install user@server:/home/xxx/
```

- å¯åŠ¨æœåŠ¡ï¼š

```bash
cd tengine-install/sbin
./tengine
```

------

### 4ï¸âƒ£ HTTP/3 éªŒè¯

- æµè§ˆå™¨è®¿é—®ï¼š

```
https://<server_ip>:8443/
```

- æŸ¥çœ‹å“åº”å¤´ï¼š

```
Alt-Svc: h3=":8443"
```

- ä½¿ç”¨ Wireshark æŠ“åŒ…ç¡®è®¤ï¼š

```
(quic || http3)
```

------

## âš™ï¸ æ‹¥å¡æ§åˆ¶é…ç½®è¯´æ˜

- æ”¯æŒçš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼š
  - **BBR**
  - **CUBIC**
  - **COPAï¼ˆéœ€é¢å¤–ä¿®æ”¹æºç ï¼‰**

### COPA æ”¯æŒè¯´æ˜

é»˜è®¤é…ç½®ä¸‹ COPA æ— æ³•ç›´æ¥å¯ç”¨ï¼Œéœ€è¦åœ¨ï¼š

- `ngx_xquic.c` ä¸­è¡¥å…… COPA æ¥å£
- å¹¶åœ¨ `xquic.h` ä¸­å£°æ˜ `xqc_copa_cb`

ä¿®æ”¹å®Œæˆåï¼Œé‡æ–°ç¼–è¯‘ Tengine å³å¯ç”Ÿæ•ˆã€‚

------

## ğŸ‘¥ è´¡çŒ®è€…

- **ç‹æ¸…æ¥ **
  è¥¿å®‰äº¤é€šå¤§å­¦
  ç ”ç©¶æ–¹å‘ï¼šæ‹¥å¡æ§åˆ¶ / QUIC / ç”¨æˆ·éœ€æ±‚æ„ŸçŸ¥ä¼ è¾“æœºåˆ¶

æ¬¢è¿å¯¹æœ¬é¡¹ç›®æ„Ÿå…´è¶£çš„ç ”ç©¶è€…å’Œå·¥ç¨‹å®è·µè€…äº¤æµä¸åˆä½œã€‚
